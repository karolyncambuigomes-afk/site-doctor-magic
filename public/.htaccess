# Five London - Optimized for External Tools & Performance Analysis
# Maximum compatibility for PageSpeed, GTmetrix, and all crawlers

# Security Headers for Admin Protection
<IfModule mod_headers.c>
    # Strict Transport Security (HSTS)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Content Security Policy
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://jiegopvbwpyfohhfvmwo.supabase.co https://vercel.live; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; connect-src 'self' https://jiegopvbwpyfohhfvmwo.supabase.co wss://jiegopvbwpyfohhfvmwo.supabase.co https://vercel.live; font-src 'self' data:; media-src 'self' blob:; object-src 'none'; frame-src 'self' https://vercel.live; base-uri 'self'; form-action 'self'"
    
    # Admin-specific security for admin routes
    <LocationMatch "^/admin">
        Header always set X-Frame-Options "DENY"
        Header always set X-Content-Type-Options "nosniff"
        Header always set Referrer-Policy "no-referrer"
        Header always set Cache-Control "no-cache, no-store, must-revalidate, private"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://jiegopvbwpyfohhfvmwo.supabase.co wss://jiegopvbwpyfohhfvmwo.supabase.co; font-src 'self'; object-src 'none'; frame-ancestors 'none'"
    </LocationMatch>
    
    # Auth pages security
    <LocationMatch "^/auth">
        Header always set X-Frame-Options "DENY"
        Header always set Cache-Control "no-cache, no-store, must-revalidate, private"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
    </LocationMatch>
    
    # Secure cookie flags
    Header always edit Set-Cookie ^(.*)$ "$1; HttpOnly; Secure; SameSite=Strict"
</IfModule>

# Advanced compression and caching for Grade A performance
<IfModule mod_deflate.c>
    # Comprehensive text compression
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    
    # Application content
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/ld+json
    
    # Fonts and SVG
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/woff
    AddOutputFilterByType DEFLATE font/woff2
    
    # Maximum compression for best Lighthouse scores
    DeflateCompressionLevel 9
    
    # Don't compress already compressed files
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|webp|zip|gz|tar|bz2|sit|rar|exe)$ no-gzip dont-vary
</IfModule>

# Brotli compression (superior to gzip)
<IfModule mod_brotli.c>
    BrotliCompressionQuality 6
    BrotliFilterNote Input instream
    BrotliFilterNote Output outstream
    BrotliFilterNote Ratio ratio
    
    LogFormat '"%r" %{outstream}n/%{instream}n (%{ratio}n%%)' brotli
    CustomLog logs/brotli_log brotli
    
    AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json application/xml application/rss+xml
    AddOutputFilterByType BROTLI_COMPRESS image/svg+xml font/ttf font/otf font/woff font/woff2
</IfModule>

# Advanced caching with performance optimization
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"
    
    # Images - 1 year cache with immutable
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/avif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS and JavaScript - 1 year cache
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType application/x-javascript "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    
    # Fonts - 1 year cache with CORS
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # HTML - short cache for dynamic content
    ExpiresByType text/html "access plus 1 hour"
    
    # Admin pages - no cache
    <LocationMatch "^/admin">
        ExpiresActive Off
    </LocationMatch>
    
    # Auth pages - no cache
    <LocationMatch "^/auth">
        ExpiresActive Off
    </LocationMatch>
    
    # JSON/XML - medium cache
    ExpiresByType application/json "access plus 1 day"
    ExpiresByType application/xml "access plus 1 day"
    ExpiresByType text/xml "access plus 1 day"
    
    # Manifest files
    ExpiresByType application/manifest+json "access plus 1 week"
    ExpiresByType text/cache-manifest "access plus 0 seconds"
</IfModule>

# Performance-optimized headers
<IfModule mod_headers.c>
    # Service Worker - NEVER cache (critical for updates)
    <FilesMatch "^sw(\.v?\d+)?\.js$">
        Header set Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
        Header unset ETag
        Header unset Last-Modified
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>

    # Index HTML - short cache only
    <FilesMatch "^index\.html$">
        Header set Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
        Header unset ETag
        Header unset Last-Modified
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>

    # Version JSON - never cache (for debugging)
    <Files "version.json">
        Header set Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
        Header unset ETag
        Header unset Last-Modified
        Header set Pragma "no-cache"
        Header set Expires "0"
    </Files>

    # Hard reset page - never cache
    <Files "hard-reset.html">
        Header set Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
        Header unset ETag
        Header unset Last-Modified
        Header set Pragma "no-cache"
        Header set Expires "0"
    </Files>

    # Static assets - 1 year cache with immutable
    <FilesMatch "\.(ico|jpg|jpeg|png|gif|svg|webp|avif|css|js|woff|woff2|ttf|otf|eot)$">
        Header set Cache-Control "max-age=31536000, public, immutable"
        Header set X-Content-Type-Options "nosniff"
        Header unset Last-Modified
        Header unset ETag
    </FilesMatch>

    # Images - enable CORS for CDN compatibility
    <FilesMatch "\.(jpg|jpeg|png|gif|svg|webp|avif)$">
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
        Header set Access-Control-Allow-Headers "Origin, Accept, Content-Type"
        Header set Timing-Allow-Origin "*"
    </FilesMatch>

    # Fonts - CORS and preload hints
    <FilesMatch "\.(woff|woff2|ttf|otf|eot)$">
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
        Header set Cache-Control "max-age=31536000, public, immutable"
    </FilesMatch>

    # HTML - dynamic content headers (except admin)
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "max-age=3600, public"
        Header set Vary "Accept-Encoding, User-Agent"
    </FilesMatch>

    # Performance and security headers (global)
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
    
    # Performance hints
    Header always set Accept-CH "Viewport-Width, Width, DPR"
    Header always set Critical-CH "Viewport-Width, Width"
    
    # Server optimization
    Header unset X-Powered-By
    Header unset Server
    
    # Crawlers and performance tools
    <If "%{HTTP_USER_AGENT} =~ /Googlebot|Bingbot|PageSpeed|GTmetrix|Pingdom|WebPageTest|Lighthouse|crawler|bot|spider/i">
        Header set Cache-Control "public, max-age=86400"
        Header always set X-Robots-Tag "index, follow"
        Header always set Access-Control-Allow-Origin "*"
    </If>
</IfModule>

# Enable basic ETags for better cache validation
FileETag MTime Size

# SPA Routing and Image Proxy
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # HTTPS and WWW redirects disabled for maximum compatibility
    # This ensures the site works in private browsers and internationally
    
    # Image proxy: /images/* â†’ /api/i/*
    RewriteRule ^images/(.*)$ /api/i/$1 [L,QSA]
    
    # SPA Routing - Serve index.html for all non-file requests
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteCond %{REQUEST_URI} !^/supabase/
    RewriteCond %{REQUEST_URI} !^/images/
    RewriteRule . /index.html [L]
</IfModule>